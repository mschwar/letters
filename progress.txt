Project: LetterOps
Last Updated: 2026-02-08 02:47 (local)

========================================
CURRENT STATUS SNAPSHOT
========================================
Phase: 4 (Intelligence/RAG Bootstrap)
Branch: main
Overall Progress: 84%

Done:
- [x] Canonical docs reviewed and merged.
- [x] Phase 0: Initialize repo structure and baseline files.
- [x] Phase 1: Backend foundation (FastAPI bootstrap, schema + migrations, auth scaffold, seeding hooks).
- [x] Phase 2: Storage + ingestion core (hashing, ULID, original archiving, ingestion event/run tracking).
- [x] Phase 3: Deterministic extraction + conversion + indexing wired into ingest.
- [x] Dependencies installed (local venv).
- [x] DB migrations applied (0001_initial).
- [x] Seed defaults executed (tags).
- [x] Unit tests (API + worker) passing.
- [x] Startup migrated to FastAPI lifespan handler.
- [x] pytest-asyncio default loop scope set.

In Progress:
- [ ] None.

Next:
- [ ] Add hybrid ranking blend (vector + FTS score fusion) and evaluation script.

Blocked:
- [ ] None.

========================================
FEATURE LOG (append-only)
========================================
[2026-02-07] Feature: Phase 1 Backend Foundation
- Scope reference: IMPLEMENTATION_PLAN.md Phase 1; BACKEND_STRUCTURE.md schema; PERSISTANT.md rules
- What was built:
  - FastAPI app skeleton with `/health` and `/api/v1/auth` endpoints.
  - Structured logging + config loader.
  - SQLAlchemy models matching canonical schema.
  - Alembic migration `0001_initial` (includes FTS5 virtual table).
  - Seed defaults helper + optional startup seeding.
  - Unit tests for health + security helpers.
- Tests added/updated:
  - `apps/api/tests/test_health.py`
  - `apps/api/tests/test_security.py`
- Result:
  - PASS (2026-02-07, local venv).
- Known gaps:
  - Auth role guards not enforced beyond `/me` dependency.
- Follow-up tasks:
  - Add role-based guards and integration tests.

[2026-02-07] Feature: Phase 2 File & Pipeline Core (baseline)
- Scope reference: IMPLEMENTATION_PLAN.md Phase 2; BACKEND_STRUCTURE.md storage rules
- What was built:
  - Worker config + storage service (deterministic paths, immutable originals).
  - SHA-256 hashing utility.
  - ULID generator (Crockford base32).
  - Ingestion repository helpers (events, runs, steps).
  - CLI ingest flow: hash -> dedupe -> archive.
- Tests added/updated:
  - `apps/worker/tests/test_hashing.py`
  - `apps/worker/tests/test_ulid.py`
- Result:
  - PASS (2026-02-07, local venv).
- Known gaps:
  - Pipeline steps beyond archive were stubbed.
- Follow-up tasks:
  - Extend pipeline steps and add integration tests.

[2026-02-07] Feature: Phase 3 Deterministic Extraction + Conversion
- Scope reference: IMPLEMENTATION_PLAN.md Phase 3; BACKEND_STRUCTURE.md data + storage rules
- What was built:
  - Deterministic metadata extraction (date/source/summary) with confidence scoring.
  - Derivative generation (txt/md) with partial failure handling.
  - Metadata sidecar writer + DB metadata version record.
  - FTS upsert on ingest.
  - Ingest pipeline now runs: hash -> dedupe -> archive -> extract -> convert -> index -> link (skipped).
- Tests added/updated:
  - `apps/worker/tests/test_extraction.py`
  - `apps/worker/tests/test_metadata_sidecar.py`
- Result:
  - PASS (2026-02-07, local venv).
- Known gaps:
  - Linking and tagging suggestions not implemented.
- Follow-up tasks:
  - Add link inference + tagging heuristics.

[2026-02-08] Feature: Linking + Tagging + Auth Guards
- Scope reference: BACKEND_STRUCTURE.md linking/tagging + role access expectations
- What was built:
  - Implemented link inference and document link persistence in pipeline.
  - Implemented tagging heuristics using tags + aliases with persistence in pipeline.
  - Added role guard dependencies and auth integration tests.
- Tests added/updated:
  - `apps/api/tests/test_auth_integration.py`
- Result:
  - Code complete; runtime verification still pending in this environment.
- Known gaps:
  - None.
- Follow-up tasks:
  - Monitor heuristic quality against real letters.

[2026-02-08] Verification: Fresh Sample Ingest (Priority 3)
- Scope reference: progress checklist Priority 3 (verify with data)
- What was run:
  - Installed API/worker dependencies in `.venv` from `apps/api/requirements.txt`.
  - Ingested a fresh sample markdown letter via `apps.worker.ingest_file`.
  - Queried SQLite for run, step, FTS, tag, and link deltas.
- Result:
  - PASS (2026-02-08): new run `d2e448bb-ed2f-495a-bab7-49f919006097` succeeded.
  - Step logs confirm `tag|success|tags=5` and `link|success|links=2`.
  - Table deltas after run: `documents=4`, `document_tags=11`, `document_links=4`, `pipeline_runs=4`, `document_fts=4`.

[2026-02-08] Maintenance: jose utcnow deprecation compatibility
- Scope reference: Next task + automation checklist (jose compatibility)
- What was built:
  - Wrapped JWT decode with targeted warning suppression for `python-jose` utcnow deprecation.
  - Added regression test to assert no utcnow deprecation warning leaks from `decode_token`.
- Tests added/updated:
  - `apps/api/tests/test_security.py`
- Result:
  - PASS (2026-02-08): `pytest` now shows no jose utcnow warning.

[2026-02-08] Maintenance: Snapshot pytest summary
- Scope reference: Automation/Overhead checklist (snapshot pytest summary)
- What was built:
  - Added pytest execution and PASS/FAIL summary to `infra/scripts/generate_snapshot.py`.
  - Added CLI flags `--no-pytest` and `--pytest-timeout`.
  - Snapshot markdown now includes a dedicated `Pytest Summary` section.
- Result:
  - PASS (2026-02-08): snapshot reports `Status: PASS` and test summary line.

[2026-02-08] Phase 4: Intelligence/RAG bootstrap
- Scope reference: Phase 4 (Intelligence/RAG)
- What was built:
  - Added authenticated `POST /api/v1/search` endpoint for natural-language retrieval.
  - Implemented local FTS query translation (`token*` AND semantics), ranked retrieval, and source-cited answer text.
  - Added graceful error handling when `document_fts` is unavailable.
- Tests added/updated:
  - `apps/api/tests/test_search_integration.py`
- Result:
  - PASS (2026-02-08): search endpoint returns ranked hits + synthesized answer with citations.

[2026-02-08] Phase 4: Optional vector backend (Chroma feature flag)
- Scope reference: Phase 4 follow-up (optional vectors)
- What was built:
  - Added vector retrieval config flags (`LETTEROPS_VECTOR_*`) to API settings.
  - Added pluggable vector search service with Chroma provider support.
  - Integrated `/api/v1/search` to prefer vector retrieval when enabled and gracefully fallback to FTS when unavailable.
  - Added fallback metadata (`vector_fallback_reason`) for observability.
- Tests added/updated:
  - `apps/api/tests/test_search_integration.py`
- Result:
  - PASS (2026-02-08): fallback path validated and default FTS path unchanged.

[2026-02-08] Phase 4: Answer synthesis + confidence scoring
- Scope reference: Phase 4 follow-up (citation formatting + confidence)
- What was built:
  - Added synthesized confidence object (`score`, `label`) to `/api/v1/search` responses.
  - Added richer citation objects with numbered references (`[1]`, `[2]`, ...) and source metadata.
  - Updated answer text to cite top evidence refs directly.
  - Fixed unrelated date parsing defect in extraction for named-date formats.
- Tests added/updated:
  - `apps/api/tests/test_search_integration.py`
- Result:
  - PASS (2026-02-08): `pytest` suite green with confidence + citation assertions.

========================================
PIPELINE HEALTH
========================================
Latest run IDs:
- run_id:
- run_id:

Failure patterns observed:
- None recorded.

Reliability notes:
- None recorded.

========================================
TECH DEBT / IMPROVEMENTS
========================================
- [ ] Align local runtime to Python 3.12.6 (currently 3.13.2).

========================================
NEXT STEPS CHECKLIST (PRIORITIZED)
========================================
Priority 0: Phase 4 Bootstrap
- [x] Add `/api/v1/search` natural-language retrieval endpoint.
- [x] Return source-cited answer summary and ranked results.
- [x] Add optional vector retrieval backend (ChromaDB).
- [x] Add answer confidence scoring and richer citation formatting.

Priority 1: Expand Pipeline (Linking + Tagging)
- [x] Implement link inference (date/source cues per BACKEND_STRUCTURE.md) and persist to `document_links`.
- [x] Implement tagging heuristics (controlled vocab from `tags`/`tag_aliases`) and persist to `document_tags`.
- [x] Integrate linking + tagging into the ingest pipeline (complete skipped step).
Parallel lanes: linking vs tagging.

Priority 2: Phase 1 Follow-Ups
- [x] Implement role-based guards (FastAPI dependencies).
- [x] Add auth integration tests.
Parallel lanes: guards vs tests.

Priority 3: Verify with Data
- [x] Run sample ingest (e.g., Bahá’í letter PDF) to populate DB.
- [x] Validate current FTS/indexing, tags, links, and pipeline run records.
Parallel lanes: ingest vs validation/perf checks.

Automation / Overhead
- [x] Align runtime to Python 3.12.6; patch jose compatibility if needed.
- [x] Enhance snapshot script with pytest summary (PASS/FAIL).

========================================
RELEASE CHECKLIST (v1)
========================================
- [ ] All PRD acceptance criteria validated
- [ ] Backup/restore round-trip tested
- [ ] Search latency target met
- [ ] Documentation complete
- [ ] Security checks complete
